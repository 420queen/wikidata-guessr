<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <title>Wikidata Guessr</title>
  <link rel='stylesheet' href='css/bootstrap.css' />
  <link rel='stylesheet' href='css/style.css' />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
  <script type='text/javascript' src='js/minimap.js'></script>
  <script type='text/javascript' src='js/roundmap.js'></script>
  <script>
    let current = 0;
    let totalScore = 0;
    let data = [];

    async function loadData() {
      try {
        const response = await fetch('locations.json');
        data = await response.json();
        mminitialize(); // â† THIS calls the original map init function
        startRound();
      } catch (err) {
        alert('Error loading locations.json: ' + err);
        console.error(err);
      }
    }

    function startRound() {
      if (current >= data.length) {
        document.getElementById("endGame").style.display = "block";
        document.getElementById("endGame").innerHTML = "<h2>Game Over</h2><p>Total Score: " + totalScore + "</p>";
        return;
      }

      const item = data[current];
      document.getElementById("image").src = item.image;
      document.querySelector(".round b").textContent = (current + 1) + "/" + data.length;

      document.getElementById("guessButton").onclick = () => {
        const actual = L.latLng(item.lat, item.lon);
        const guess = L.latLng(window.guessLatLng.lat, window.guessLatLng.lng);
        const distance = guess.distanceTo(actual) / 1000;
        const score = Math.max(0, 5000 - Math.round(distance));
        totalScore += score;

        document.querySelector(".roundScore b").textContent = score;
        document.querySelector(".totalScore b").textContent = totalScore;

        L.marker(actual).addTo(mymap); // defined in minimap.js
        L.polyline([guess, actual]).addTo(mymap);

        current++;
        setTimeout(startRound, 3000);
      };
    }

    window.onload = loadData;
  </script>
</head>
<body>
  <div id='content'>
    <div id="roundEnd"></div>
    <div id="endGame"></div>
    <div id='scoreBoard'>
      <span class='round'>Current Round: <b>1/5</b></span><br/>
      <span class='roundScore'>Last Round Score: <b>0</b></span><br/>
      <span class='totalScore'>Total Score: <b>0</b></span><br />
      <span><a href="https://github.com/blinry/wikidata-guessr">View project on GitHub</a></span>
    </div>
    <div id='miniMap'></div>
    <div id='guessButton' class="btn btn-large btn-danger">Make Your Guess</div>
    <img id='image' src='' />
  </div>
</body>
</html>

